CREATE TABLE users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    email VARCHAR(64) NOT NULL UNIQUE,
    name VARCHAR(64) NOT NULL,
    password BYTEA NOT NULL,
    PRIMARY KEY(id)
);

CREATE TABLE accounts (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    owner BIGINT NOT NULL,
    type SMALLINT NOT NULL,
    name VARCHAR(64) NOT NULL,
    balance REAL DEFAULT 0,
    UNIQUE(owner, name),
    FOREIGN KEY(owner) REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
    PRIMARY KEY(id)
);

CREATE TABLE transactions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    type SMALLINT NOT NULL,
    amount DECIMAL NOT NULL,
    date DATE NOT NULL DEFAULT CURRENT_DATE,
    PRIMARY KEY(id)
);

CREATE TABLE transfers (
    id BIGINT NOT NULL UNIQUE,
    source BIGINT NOT NULL,
    target BIGINT NOT NULL,
    CHECK (source <> target),
    FOREIGN KEY(id) REFERENCES transactions(id) ON UPDATE CASCADE ON DELETE CASCADE,
    FOREIGN KEY(source) REFERENCES accounts(id) ON UPDATE CASCADE ON DELETE CASCADE,
    FOREIGN KEY(target) REFERENCES accounts(id) ON UPDATE CASCADE ON DELETE CASCADE,
    PRIMARY KEY(id)
);